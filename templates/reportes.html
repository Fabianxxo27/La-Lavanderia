{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-5">
    <h1 class="mb-5">üìä Reportes y Estad√≠sticas</h1>

    <!-- KPIs (M√©tricas clave) -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h6 class="card-title">Total de Clientes</h6>
                    <h2 class="card-text">{{ total_clientes }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h6 class="card-title">Total de Pedidos</h6>
                    <h2 class="card-text">{{ total_pedidos }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <h6 class="card-title">Total de Prendas</h6>
                    <h2 class="card-text">{{ total_prendas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h6 class="card-title">Ingresos Totales</h6>
                    <h2 class="card-text">${{ "%.2f"|format(total_ingresos) }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos principales -->
    <div class="row mb-5">
        <!-- Pedidos por d√≠a -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìà Pedidos por D√≠a (√öltimos 30 d√≠as)</h5>
                </div>
                <div class="card-body">
                    <canvas id="pedidosDiaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Clientes nuevos -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üë• Clientes Nuevos por D√≠a (√öltimos 30 d√≠as)</h5>
                </div>
                <div class="card-body">
                    <canvas id="clientesNuevosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos secundarios -->
    <div class="row mb-5">
        <!-- Tipos de prendas -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üëï Prendas por Tipo</h5>
                </div>
                <div class="card-body">
                    <canvas id="prendasTipoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Estado de pedidos -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">‚úÖ Estado de Pedidos</h5>
                </div>
                <div class="card-body">
                    <canvas id="estadoPedidosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- M√°s gr√°ficos -->
    <div class="row mb-5">
        <!-- Top clientes -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">‚≠ê Top 10 Clientes por Pedidos</h5>
                </div>
                <div class="card-body">
                    <canvas id="topClientesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ingresos por mes -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üí∞ Ingresos por Mes (√öltimos 12 meses)</h5>
                </div>
                <div class="card-body">
                    <canvas id="ingresosMesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Promedio de prendas -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5>üìä M√©trica: Promedio de Prendas por Pedido</h5>
                    <h3 class="text-primary">{{ promedio_prendas }} prendas</h3>
                    <small class="text-muted">Este es el n√∫mero promedio de prendas que se incluyen en cada pedido</small>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVAS SECCIONES DE REPORTES -->
    <hr class="my-5">
    <h3 class="mb-4"><i class="fas fa-chart-line"></i> An√°lisis Adicionales</h3>

    <!-- Tabla: Pedidos por Estado -->
    <div class="row mb-5">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-list-check"></i> Resumen por Estado</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Estado</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-right">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if estado_pedidos %}
                                {% set total_estados = estado_pedidos|length %}
                                {% for estado in estado_pedidos %}
                                <tr>
                                    <td>
                                        {% if estado[0] == 'Completado' %}
                                            <span class="badge bg-success">{{ estado[0] }}</span>
                                        {% elif estado[0] == 'En proceso' %}
                                            <span class="badge bg-info">{{ estado[0] }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ estado[0] }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center"><strong>{{ estado[1] }}</strong></td>
                                    <td class="text-right">{{ "%.1f"|format((estado[1] / total_pedidos * 100) if total_pedidos > 0 else 0) }}%</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top 5 Prendas M√°s Solicitadas -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Top 5 Prendas M√°s Solicitadas</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Prenda</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-right">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if prendas_top %}
                                {% set total_prendas_top = prendas_top|map(attribute=1)|list|sum %}
                                {% for prenda in prendas_top[:5] %}
                                <tr>
                                    <td>{{ prenda[0] }}</td>
                                    <td class="text-center"><strong>{{ prenda[1] }}</strong></td>
                                    <td class="text-right">{{ "%.1f"|format((prenda[1] / total_prendas_top * 100) if total_prendas_top > 0 else 0) }}%</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Clientes con M√°s Pedidos -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Clientes M√°s Activos (Top 10)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th class="text-center">Pedidos</th>
                                <th class="text-center">Prendas Totales</th>
                                <th class="text-right">Gasto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if clientes_activos %}
                                {% for cliente in clientes_activos[:10] %}
                                <tr>
                                    <td><strong>{{ loop.index }}</strong></td>
                                    <td>{{ cliente[1] }}</td>
                                    <td class="text-center"><span class="badge bg-primary">{{ cliente[2] }}</span></td>
                                    <td class="text-center"><strong>{{ cliente[3] }}</strong></td>
                                    <td class="text-right">${{ "{:,.0f}".format(cliente[4]) }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Adicionales -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        <i class="fas fa-check-circle"></i> Tasa de Completaci√≥n
                    </div>
                    <div class="h3 mb-0">
                        {{ "%.1f"|format(tasa_completacion) }}%
                    </div>
                    <small class="text-muted">De pedidos completados</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        <i class="fas fa-shopping-bag"></i> Promedio de Gasto
                    </div>
                    <div class="h3 mb-0">
                        ${{ "{:,.0f}".format(promedio_gasto) }}
                    </div>
                    <small class="text-muted">Por cliente</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                        <i class="fas fa-hourglass-half"></i> Pendientes
                    </div>
                    <div class="h3 mb-0">
                        {{ pedidos_pendientes }}
                    </div>
                    <small class="text-muted">Pedidos sin completar</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                        <i class="fas fa-calendar-alt"></i> Promedio de D√≠as
                    </div>
                    <div class="h3 mb-0">
                        {{ "%.1f"|format(promedio_dias) }} d√≠as
                    </div>
                    <small class="text-muted">Desde ingreso a entrega</small>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Datos desde backend
    const graficos = JSON.parse('{{ graficos | safe }}');

    // Colores personalizados
    const coloresPrimarios = [
        '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0',
        '#00BCD4', '#FFC107', '#795548', '#607D8B', '#E91E63'
    ];

    // 1. Pedidos por d√≠a
    const ctxPedidosDia = document.getElementById('pedidosDiaChart').getContext('2d');
    new Chart(ctxPedidosDia, {
        type: 'line',
        data: {
            labels: graficos.pedidos_dia.labels,
            datasets: [{
                label: 'Cantidad de Pedidos',
                data: graficos.pedidos_dia.data,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // 2. Clientes nuevos
    const ctxClientesNuevos = document.getElementById('clientesNuevosChart').getContext('2d');
    new Chart(ctxClientesNuevos, {
        type: 'bar',
        data: {
            labels: graficos.clientes_nuevos.labels,
            datasets: [{
                label: 'Clientes Nuevos',
                data: graficos.clientes_nuevos.data,
                backgroundColor: '#4CAF50',
                borderColor: '#388E3C',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // 3. Prendas por tipo
    const ctxPrendasTipo = document.getElementById('prendasTipoChart').getContext('2d');
    new Chart(ctxPrendasTipo, {
        type: 'doughnut',
        data: {
            labels: graficos.prendas_tipo.labels,
            datasets: [{
                data: graficos.prendas_tipo.data,
                backgroundColor: coloresPrimarios.slice(0, graficos.prendas_tipo.labels.length),
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 4. Estado de pedidos
    const ctxEstadoPedidos = document.getElementById('estadoPedidosChart').getContext('2d');
    new Chart(ctxEstadoPedidos, {
        type: 'pie',
        data: {
            labels: graficos.estado_pedidos.labels,
            datasets: [{
                data: graficos.estado_pedidos.data,
                backgroundColor: ['#FF9800', '#4CAF50', '#2196F3', '#F44336'],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // 5. Top clientes
    const ctxTopClientes = document.getElementById('topClientesChart').getContext('2d');
    new Chart(ctxTopClientes, {
        type: 'bar',
        data: {
            labels: graficos.top_clientes.labels,
            datasets: [{
                label: 'Cantidad de Pedidos',
                data: graficos.top_clientes.data,
                backgroundColor: '#9C27B0',
                borderColor: '#6A1B9A',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });

    // 6. Ingresos por mes
    const ctxIngresosMes = document.getElementById('ingresosMesChart').getContext('2d');
    new Chart(ctxIngresosMes, {
        type: 'bar',
        data: {
            labels: graficos.ingresos_mes.labels,
            datasets: [{
                label: 'Ingresos ($)',
                data: graficos.ingresos_mes.data,
                backgroundColor: '#00BCD4',
                borderColor: '#00838F',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>

<style>
    .card {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s;
        border-radius: 12px;
        border: none;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .card-header {
        border-bottom: 2px solid rgba(0,0,0,0.1);
        border-radius: 12px 12px 0 0;
    }
    .card.border-left-primary {
        border-left: 4px solid #4CAF50;
    }
    .card.border-left-success {
        border-left: 4px solid #2196F3;
    }
    .card.border-left-warning {
        border-left: 4px solid #FF9800;
    }
    .card.border-left-info {
        border-left: 4px solid #00BCD4;
    }
    .text-xs {
        font-size: 0.75rem;
    }
    .font-weight-bold {
        font-weight: 600;
    }
    .text-uppercase {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>

{% endblock %}

