{% extends "base.html" %}
{% block title %}Crear Pedido - La Lavandería{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h2 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Crear Nuevo Pedido
                    </h2>
                    <p class="mb-0 mt-2 opacity-75">Selecciona las prendas y cantidades para tu pedido</p>
                </div>
                
                <div class="card-body p-4">
                    <form method="post" action="{{ url_for('agregar_pedido') }}" id="formPedido">
                        
                        <!-- Selección de Cliente (solo admin) -->
                        {% if rol == 'administrador' %}
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-user-shield"></i> <strong>Modo Administrador:</strong> Selecciona el cliente para este pedido
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user"></i> Cliente
                            </label>
                            <select class="form-select form-select-lg" name="id_cliente" required>
                                <option value="">-- Seleccione un cliente --</option>
                                {% for c in clientes %}
                                    <option value="{{ c[0] }}">{{ c[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle"></i> El pedido se creará asociado a tu cuenta
                        </div>
                        {% endif %}

                        <!-- Selector de Prendas -->
                        <div class="card border-primary mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-tshirt"></i> Agregar Prendas al Pedido
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Tipo de Prenda</label>
                                        <select class="form-select" id="selectPrenda">
                                            <option value="">-- Selecciona una prenda --</option>
                                            {% for prenda in prendas_default %}
                                                <option value="{{ prenda.nombre }}" data-precio="{{ prenda.precio }}">
                                                    {{ prenda.nombre }} - ${{ "{:,.0f}".format(prenda.precio) }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Cantidad</label>
                                        <input type="number" class="form-control" id="inputCantidad" min="1" value="1">
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button type="button" class="btn btn-success w-100" id="btnAgregarPrenda">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>


                                <!-- Descripción adicional -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Descripción Adicional (Opcional)</label>
                                    <input type="text" class="form-control" id="inputDescripcion" placeholder="Color, talla, características especiales, etc.">
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Prendas Agregadas -->
                        <div class="card border-success mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-check"></i> Prendas en el Pedido
                                </h5>
                            </div>
                            <div class="card-body" id="listaPrendas">
                                <div class="text-center text-muted py-4" id="emptyMessage">
                                    <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                                    <p>No hay prendas agregadas aún. Usa el formulario de arriba para agregar prendas.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen del Pedido -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-calculator"></i> Resumen del Pedido
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-4 mb-3">
                                        <div class="p-3 bg-light rounded">
                                            <p class="text-muted mb-1">Total de Prendas</p>
                                            <h3 class="mb-0 text-primary" id="totalPrendas">0</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="p-3 bg-light rounded">
                                            <p class="text-muted mb-1">Días de Entrega</p>
                                            <h3 class="mb-0 text-warning" id="diasEntrega">-</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="p-3 bg-light rounded">
                                            <p class="text-muted mb-1">Costo Estimado</p>
                                            <h3 class="mb-0 text-success" id="costoTotal">$0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mb-0">
                                    <small>
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Tiempo de entrega:</strong> 3 días (1-5 prendas), 5 días (6-15 prendas), 7 días (más de 15 prendas)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('pedidos') if rol == 'administrador' else url_for('cliente_pedidos') }}" 
                               class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="btnCrearPedido">
                                <i class="fas fa-check-circle"></i> Crear Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .prenda-card {
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }
    .prenda-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .btn-delete-prenda {
        opacity: 0.7;
        transition: opacity 0.3s;
    }
    .btn-delete-prenda:hover {
        opacity: 1;
    }
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .badge-cantidad {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    
    const selectPrenda = document.getElementById('selectPrenda');
    const inputCantidad = document.getElementById('inputCantidad');
    const inputDescripcion = document.getElementById('inputDescripcion');
    const btnAgregarPrenda = document.getElementById('btnAgregarPrenda');
    const listaPrendas = document.getElementById('listaPrendas');
    const emptyMessage = document.getElementById('emptyMessage');
    const formPedido = document.getElementById('formPedido');
    
    console.log('Elements found - selectPrenda:', selectPrenda, 'btnAgregarPrenda:', btnAgregarPrenda, 'formPedido:', formPedido);
    
    let prendasArray = [];

    // Agregar prenda al array
    btnAgregarPrenda.addEventListener('click', function() {
        let tipoPrenda = selectPrenda.value;
        
        if (!tipoPrenda) {
            alert('Selecciona un tipo de prenda');
            return;
        }

        const cantidad = parseInt(inputCantidad.value) || 1;
        const descripcion = inputDescripcion.value.trim();
        const selectedOption = selectPrenda.selectedOptions[0];
        const precio = selectedOption && selectedOption.dataset.precio ? parseInt(selectedOption.dataset.precio) : 0;

        prendasArray.push({
            tipo: tipoPrenda,
            cantidad: cantidad,
            descripcion: descripcion,
            precio: precio
        });

        renderPrendas();
        
        // Limpiar campos
        selectPrenda.value = '';
        inputCantidad.value = '1';
        inputDescripcion.value = '';
    });

    // Renderizar lista de prendas
    function renderPrendas() {
        if (prendasArray.length === 0) {
            emptyMessage.classList.remove('d-none');
            listaPrendas.innerHTML = '';
            listaPrendas.appendChild(emptyMessage);
            actualizarResumen();
            return;
        }

        emptyMessage.classList.add('d-none');
        listaPrendas.innerHTML = '';

        prendasArray.forEach((prenda, index) => {
            const card = document.createElement('div');
            card.className = 'card prenda-card mb-2';
            card.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">
                                <i class="fas fa-tshirt text-primary"></i> 
                                <strong>${prenda.tipo}</strong>
                            </h6>
                            ${prenda.descripcion ? `<small class="text-muted">${prenda.descripcion}</small>` : ''}
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge badge-cantidad bg-primary">
                                <i class="fas fa-hashtag"></i> ${prenda.cantidad} unidad${prenda.cantidad > 1 ? 'es' : ''}
                            </span>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="text-success fw-bold">
                                <i class="fas fa-dollar-sign"></i> ${(prenda.precio * prenda.cantidad).toLocaleString('es-CO')}
                            </span>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-danger btn-sm btn-delete-prenda" data-index="${index}">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            listaPrendas.appendChild(card);
        });

        actualizarResumen();
    }

    // Eliminar prenda
    listaPrendas.addEventListener('click', function(e) {
        if (e.target.closest('.btn-delete-prenda')) {
            const index = e.target.closest('.btn-delete-prenda').dataset.index;
            prendasArray.splice(index, 1);
            renderPrendas();
        }
    });

    // Actualizar resumen
    function actualizarResumen() {
        const totalPrendas = prendasArray.reduce((sum, p) => sum + p.cantidad, 0);
        const costoTotal = prendasArray.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
        
        let diasEntrega = 3;
        if (totalPrendas > 15) diasEntrega = 7;
        else if (totalPrendas > 5) diasEntrega = 5;

        document.getElementById('totalPrendas').textContent = totalPrendas;
        document.getElementById('diasEntrega').textContent = totalPrendas > 0 ? `${diasEntrega} días` : '-';
        document.getElementById('costoTotal').textContent = `$${costoTotal.toLocaleString('es-CO')}`;
    }

    // Submit form
    formPedido.addEventListener('submit', function(e) {
        console.log('Form submitted, prendasArray length:', prendasArray.length);
        
        if (prendasArray.length === 0) {
            e.preventDefault();
            alert('Debes agregar al menos una prenda al pedido');
            return false;
        }

        // Agregar campos hidden al formulario
        console.log('Agregando campos hidden al formulario...');
        prendasArray.forEach((prenda, index) => {
            console.log(`Agregando prenda ${index}:`, prenda);
            
            const inputTipo = document.createElement('input');
            inputTipo.type = 'hidden';
            inputTipo.name = 'tipo[]';
            inputTipo.value = prenda.tipo;
            formPedido.appendChild(inputTipo);

            const inputCantidad = document.createElement('input');
            inputCantidad.type = 'hidden';
            inputCantidad.name = 'cantidad[]';
            inputCantidad.value = prenda.cantidad;
            formPedido.appendChild(inputCantidad);

            const inputDescripcion = document.createElement('input');
            inputDescripcion.type = 'hidden';
            inputDescripcion.name = 'descripcion[]';
            inputDescripcion.value = prenda.descripcion;
            formPedido.appendChild(inputDescripcion);
        });
        
        console.log('Form data ready, submitting...');
        // No retornar false, permitir que el formulario se envíe
    });

    // Inicializar
    actualizarResumen();
});
</script>

{% endblock %}
