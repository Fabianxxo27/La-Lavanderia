{% extends "base.html" %}
{% block title %}Crear Pedido{% endblock %}

{% block content %}
<h3>Crear Pedido</h3>
<form method="post" action="{{ url_for('agregar_pedido') }}">
  {% set lista_clientes = clients if clients is defined else (clientes if clientes is defined else []) %}

  {% if rol == 'administrador' %}
  <div class="mb-3">
    <label class="form-label">Cliente</label>
    <select class="form-select" name="id_cliente" required>
      <option value="">-- Seleccione cliente --</option>
      {% for c in lista_clientes %}
        <option value="{{ c[0] }}">{{ c[1] }}</option>
      {% endfor %}
    </select>
  </div>
  {% else %}
  <p>Se creará el pedido asociado a tu cuenta.</p>
  {% endif %}

  <div class="mb-3">
    <label class="form-label">Cantidad de artículos</label>
    <input type="number" min="1" class="form-control" name="cantidad_articulos" required>
    <small class="form-text text-muted">La fecha de entrega se calculará automáticamente según la cantidad (3-7 días).</small>
  </div>
  <div class="mb-3">
    <label class="form-label">Fecha de entrega estimada</label>
    <div id="fecha_estimada" class="form-control-plaintext">—</div>
  </div>

  <hr>
  <h5>Prendas (agrega las prendas del pedido)</h5>
  <div id="prendas_container">
    <!-- filas de prendas serán añadidas aquí -->
  </div>
  <button type="button" id="add_prenda" class="btn btn-outline-primary mb-3">Agregar prenda</button>

  <!-- plantilla JS para una prenda -->
  <template id="tpl_prenda">
    <div class="card mb-2 p-2 prenda-item">
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-sm btn-danger btn-remove-prenda">Eliminar</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Tipo</label>
        <input name="tipo" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Descripción</label>
        <input name="descripcion" class="form-control">
      </div>
      <div class="mb-2">
        <label class="form-label">Observaciones</label>
        <input name="observaciones" class="form-control">
      </div>
    </div>
  </template>
  {% if rol == 'administrador' %}
  <div class="mb-3">
    <label class="form-label">Estado</label>
    <select name="estado" class="form-control">
      <option value="Pendiente">Pendiente</option>
      <option value="En proceso">En proceso</option>
      <option value="Completado">Completado</option>
    </select>
  </div>
  {% else %}
  <div class="mb-3">
    <label class="form-label">Estado (asignado por el sistema)</label>
    <div class="form-control-plaintext">Pendiente</div>
    <!-- no se expone input para que el cliente no pueda establecer el estado -->
  </div>
  {% endif %}
  <button class="btn btn-success">Crear</button>
  <a href="{{ url_for('pedidos') if rol == 'administrador' else url_for('cliente_pedidos') }}" class="btn btn-secondary">Cancelar</a>
</form>
<script>
// Calcular fecha estimada en cliente según cantidad
function calcularDias(cantidad){
  cantidad = Number(cantidad) || 0;
  if(cantidad <= 5) return 3;
  if(cantidad <= 15) return 5;
  return 7;
}

function actualizarFechaEstimada(){
  const inp = document.querySelector('input[name="cantidad_articulos"]');
  const cont = document.getElementById('fecha_estimada');
  if(!inp) return;
  const cantidad = Number(inp.value) || 0;
  if(cantidad <= 0){ cont.textContent = '—'; return; }
  const dias = calcularDias(cantidad);
  const hoy = new Date();
  hoy.setDate(hoy.getDate() + dias);
  cont.textContent = hoy.toISOString().slice(0,10) + ' (+' + dias + ' días)';
}

document.addEventListener('DOMContentLoaded', function(){
  const addBtn = document.getElementById('add_prenda');
  const container = document.getElementById('prendas_container');
  const tpl = document.getElementById('tpl_prenda');

  addBtn.addEventListener('click', function(){
    const node = tpl.content.cloneNode(true);
    // ajustar nombres para que lleguen como arrays: tipo[], descripcion[], observaciones[]
    node.querySelectorAll('[name]').forEach(function(el){
      const n = el.getAttribute('name');
      el.setAttribute('name', n + '[]');
    });
    container.appendChild(node);
  });

  container.addEventListener('click', function(e){
    if(e.target.classList.contains('btn-remove-prenda')){
      const it = e.target.closest('.prenda-item');
      if(it) it.remove();
    }
  });

  const cantidadInp = document.querySelector('input[name="cantidad_articulos"]');
  if(cantidadInp){
    cantidadInp.addEventListener('input', actualizarFechaEstimada);
    actualizarFechaEstimada();
  }
});
</script>
{% endblock %}
