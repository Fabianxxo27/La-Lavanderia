{% extends "base.html" %}
{% block title %}Crear Pedido - La Lavander칤a{% endblock %}

{% block content %}
<style>
  .card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .card-header {
    background: linear-gradient(135deg, #1a4e7b 0%, #0d2a42 100%);
    border-radius: 12px 12px 0 0;
    padding: 1.5rem;
    color: white;
  }

  .card-body {
    padding: 2rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #a6cc48 0%, #8fb933 100%);
    border: none;
    font-weight: 600;
    color: #1a4e7b;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #8fb933 0%, #7a9e2b 100%);
  }

  .table {
    font-size: 0.95rem;
  }

  .form-select, .form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .form-select:focus, .form-control:focus {
    border-color: #a6cc48;
    box-shadow: 0 0 0 0.2rem rgba(166, 204, 72, 0.25);
  }

  .alert {
    border-radius: 8px;
    border: none;
  }
  
  /* Estilos para interactividad */
  .prenda-row {
    transition: background-color 0.2s ease;
  }
  
  .prenda-row:hover {
    background-color: #f8fdf0;
  }
  
  .resumen-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
  }
  
  .resumen-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
  }
  
  .entrega-info {
    background: #f0f7e8;
    border-left: 4px solid #a6cc48;
    padding: 1rem;
    border-radius: 4px;
  }
</style>

<div class="container py-4">
    <div class="row">
        <!-- Formulario principal -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #a6cc48 0%, #8fb933 100%); color: #1a4e7b;">
                    <h3 class="mb-0"><i class="fas fa-cart-plus"></i> Nuevo Pedido</h3>
                </div>
                
                <div class="card-body">
                    <form method="POST" action="{{ url_for('agregar_pedido') }}" id="formPedido">
                        
                        <!-- Cliente (solo admin) -->
                        {% if rol == 'administrador' %}
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-user-shield"></i> <strong>Modo Administrador</strong>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">Cliente</label>
                            <select class="form-select" name="id_cliente" id="selectCliente" required>
                                <option value="">-- Selecciona un cliente --</option>
                                {% for c in clientes %}
                                    <option value="{{ c[0] }}">{{ c[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle"></i> Pedido para tu cuenta
                        </div>
                        {% endif %}

                        <!-- Prendas -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-tshirt"></i> Prendas del Pedido</h5>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarFila()" title="Agregar otra prenda">
                                <i class="fas fa-plus"></i> Agregar Prenda
                            </button>
                        </div>
                        
                        <div class="alert alert-info small mb-3">
                            <i class="fas fa-info-circle"></i> Puedes agregar <strong>m칰ltiples tipos de prendas</strong> en un mismo pedido. Usa el bot칩n "+ Agregar Prenda" para a침adir m치s filas.
                        </div>
                        
                        <div class="table-responsive mb-4">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tipo de Prenda</th>
                                        <th width="12%">Cantidad</th>
                                        <th>Descripci칩n (Opcional)</th>
                                        <th class="text-center" width="12%">Subtotal</th>
                                        <th width="8%" class="text-center" style="color: #dc3545; font-weight: bold; font-size: 1.1rem;">
                                            <i class="fas fa-times"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpoTabla">
                                    <tr class="prenda-row">
                                        <td>
                                            <select class="form-select form-select-sm tipo-select" name="tipo[]" onchange="actualizarPrecio(this)">
                                                <option value="">-- Selecciona un tipo --</option>
                                                {% for prenda in prendas_default %}
                                                    <option value="{{ prenda.nombre }}" data-precio="{{ prenda.precio }}">
                                                        {{ prenda.nombre }} - ${{ "{:,}".format(prenda.precio) }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm cantidad-input" name="cantidad[]" min="0" value="0" onchange="calcularTotal()" oninput="calcularTotal()">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" name="descripcion[]" placeholder="Ej: Azul talla M">
                                        </td>
                                        <td class="text-center">
                                            <span class="precio-fila badge bg-secondary">$0</span>
                                        </td>
                                        <td class="text-center">
                                            <span onclick="eliminarFila(this.closest('tr'))" style="cursor: pointer; color: #dc3545; font-size: 1.3rem; font-weight: bold;" title="Eliminar fila">
                                                <i class="fas fa-times-circle"></i>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Info de entrega -->
                        <div class="entrega-info mb-4">
                            <div class="mb-2"><i class="fas fa-truck"></i> <strong>Tiempos de Entrega</strong></div>
                            <small>
                                <div class="mb-1"><strong>1-5 prendas:</strong> 3 d칤as</div>
                                <div class="mb-1"><strong>6-15 prendas:</strong> 5 d칤as</div>
                                <div><strong>16+ prendas:</strong> 7 d칤as</div>
                            </small>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <a href="{{ url_for('pedidos') if rol == 'administrador' else url_for('cliente_pedidos') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnCrear">
                                <i class="fas fa-check-circle"></i> Crear Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel de resumen (lateral) -->
        <div class="col-lg-4">
            <div class="card shadow-lg">
                <div class="card-header" style="background: linear-gradient(135deg, #a6cc48 0%, #8fb933 100%); color: #1a4e7b;">
                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Resumen</h5>
                </div>
                <div class="card-body">
                    <div class="resumen-item">
                        <span>Total de prendas:</span>
                        <strong id="totalPrendas">0</strong>
                    </div>
                    <div class="resumen-item">
                        <span>Prendas con cantidad:</span>
                        <strong id="prendasConCantidad">0</strong>
                    </div>
                    <hr>
                    <div class="resumen-item" style="font-size: 1.1rem; color: #27ae60;">
                        <span><strong>Costo Total:</strong></span>
                        <strong id="costoTotal">$0</strong>
                    </div>
                    <hr>
                    
                    <!-- Detalles de entrega -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div class="mb-2"><strong><i class="fas fa-calendar"></i> Fecha de Entrega</strong></div>
                        <div id="fechaEntrega" style="color: #1a4e7b; font-size: 0.95rem;">
                            Selecciona prendas para calcular
                        </div>
                    </div>

                    <!-- Badges de informaci칩n -->
                    <div style="margin-top: 1rem;">
                        <div id="alertaCalidad" style="display: none;">
                            <div class="alert alert-success small mb-2">
                                <i class="fas fa-check-circle"></i> Informaci칩n completa
                            </div>
                        </div>
                        <div id="alertaPedidos" class="alert alert-info small">
                            <i class="fas fa-info-circle"></i> M칤nimo 1 prenda para crear pedido
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Datos de precios
const preciosData = {
    {% for prenda in prendas_default %}
        '{{ prenda.nombre }}': {{ prenda.precio }},
    {% endfor %}
};

function agregarFila() {
    const cuerpo = document.getElementById('cuerpoTabla');
    const nuevaFila = cuerpo.rows[0].cloneNode(true);
    
    nuevaFila.classList.add('prenda-row');
    nuevaFila.querySelector('select[name="tipo[]"]').value = '';
    nuevaFila.querySelector('select[name="tipo[]"]').onchange = function() { actualizarPrecio(this); };
    nuevaFila.querySelector('input[name="cantidad[]"]').value = '0';
    nuevaFila.querySelector('input[name="cantidad[]"]').onchange = function() { calcularTotal(); };
    nuevaFila.querySelector('input[name="cantidad[]"]').oninput = function() { calcularTotal(); };
    nuevaFila.querySelector('input[name="descripcion[]"]').value = '';
    nuevaFila.querySelector('.precio-fila').textContent = '$0';
    const iconoEliminar = nuevaFila.querySelector('span[onclick*="eliminarFila"]');
    iconoEliminar.onclick = function() { eliminarFila(this.closest('tr')); };
    
    cuerpo.appendChild(nuevaFila);
    calcularTotal();
}

function actualizarPrecio(selectElement) {
    const fila = selectElement.closest('tr');
    const tipoPrenda = selectElement.value;
    const precio = preciosData[tipoPrenda] || 0;
    const cantidad = parseInt(fila.querySelector('input[name="cantidad[]"]').value) || 1;
    const precioSpan = fila.querySelector('.precio-fila');
    
    if (tipoPrenda) {
        precioSpan.textContent = '$' + (precio * cantidad).toLocaleString('es-CO');
    } else {
        precioSpan.textContent = '$0';
    }
    
    calcularTotal();
}

function eliminarFila(fila) {
    const filas = document.querySelectorAll('#cuerpoTabla tr');
    if (filas.length > 1) {
        fila.remove();
        calcularTotal();
    } else {
        alert('Debe haber al menos una fila para agregar prendas');
    }
}

function calcularTotal() {
    const filas = document.querySelectorAll('#cuerpoTabla tr');
    let costoTotal = 0;
    let totalPrendas = 0;
    let prendasConCantidad = 0;
    
    filas.forEach(fila => {
        const selectTipo = fila.querySelector('select[name="tipo[]"]');
        const inputCantidad = fila.querySelector('input[name="cantidad[]"]');
        const precioSpan = fila.querySelector('.precio-fila');
        
        const tipoPrenda = selectTipo.value;
        const cantidad = parseInt(inputCantidad.value) || 0;
        const precio = preciosData[tipoPrenda] || 0;
        
        const subtotal = precio * cantidad;
        costoTotal += subtotal;
        totalPrendas += cantidad;
        
        if (tipoPrenda && cantidad > 0) {
            prendasConCantidad++;
            precioSpan.textContent = '$' + subtotal.toLocaleString('es-CO');
        } else {
            precioSpan.textContent = '$0';
        }
    });
    
    // Actualizar resumen
    document.getElementById('totalPrendas').textContent = totalPrendas;
    document.getElementById('prendasConCantidad').textContent = prendasConCantidad;
    document.getElementById('costoTotal').textContent = '$' + costoTotal.toLocaleString('es-CO');
    
    // Calcular fecha de entrega
    calcularFechaEntrega(totalPrendas);
    
    // Validar formulario
    const btnCrear = document.getElementById('btnCrear');
    const alertaCalidad = document.getElementById('alertaCalidad');
    const alertaPedidos = document.getElementById('alertaPedidos');
    
    if (prendasConCantidad > 0 && totalPrendas > 0) {
        alertaCalidad.style.display = 'block';
        alertaPedidos.style.display = 'none';
        btnCrear.disabled = false;
    } else {
        alertaCalidad.style.display = 'none';
        alertaPedidos.style.display = 'block';
        btnCrear.disabled = true;
    }
}

function calcularFechaEntrega(totalPrendas) {
    const hoy = new Date();
    let dias = 3; // por defecto
    
    if (totalPrendas >= 16) {
        dias = 7;
    } else if (totalPrendas >= 6) {
        dias = 5;
    }
    
    const fechaEntrega = new Date(hoy);
    fechaEntrega.setDate(fechaEntrega.getDate() + dias);
    
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaTexto = fechaEntrega.toLocaleDateString('es-CO', opciones);
    
    let mensajeEntrega = `游닍 <strong>${dias} d칤as</strong><br>`;
    if (totalPrendas === 0) {
        mensajeEntrega = '<em>Selecciona prendas para calcular</em>';
    } else if (totalPrendas <= 5) {
        mensajeEntrega += `<small>Entrega aprox: ${fechaTexto}</small>`;
    } else if (totalPrendas <= 15) {
        mensajeEntrega += `<small>Entrega aprox: ${fechaTexto}</small>`;
    } else {
        mensajeEntrega += `<small>Entrega aprox: ${fechaTexto}</small>`;
    }
    
    document.getElementById('fechaEntrega').innerHTML = mensajeEntrega;
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Solo una fila por defecto
    calcularTotal();
});
</script>
{% endblock %}
